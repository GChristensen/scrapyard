<html>
<head>
    <title></title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="cache-control" content="no-cache">
    <meta http-equiv="expires" content="0">

    <link rel="stylesheet" href="lib/jstree/themes/default/style.css"/>
    <link rel="stylesheet" href="tree.css"/>
    <link rel="stylesheet" href="vars.css"/>

    <script type="text/javascript" src="lib/jquery.js"></script>
    <script type="text/javascript" src="lib/jstree/jstree.js"></script>


    <style>
        body {
            margin: 0;
        }

        #animation {
            position: fixed;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            background-image: var(--themed-loading-icon);
            background-position: center;
            background-repeat: no-repeat;
        }

        a.has-notes, a.has-notes:hover {
            text-decoration: underline !important;
        }
    </style>

</head>
<html>
    <div id="animation"></div>
    <div id="treeview"></div>

   <script type="text/javascript">
        const NODE_TYPE_SHELF = 1;
        const NODE_TYPE_GROUP = 2;
        const NODE_TYPE_BOOKMARK = 3;
        const NODE_TYPE_ARCHIVE = 4;
        const NODE_TYPE_SEPARATOR = 5;
        const NODE_TYPE_NOTES = 6;

        const CLOUD_SHELF_ID = -5;
        const CLOUD_SHELF_NAME = "cloud";
        const CLOUD_EXTERNAL_NAME = "cloud";


        const TODO_STATE_TODO = 1;
        const TODO_STATE_DONE = 4;
        const TODO_STATE_WAITING = 2;
        const TODO_STATE_POSTPONED = 3;
        const TODO_STATE_CANCELLED = 5;

        const TODO_NAMES = {
            [TODO_STATE_TODO]: "TODO",
            [TODO_STATE_WAITING]: "WAITING",
            [TODO_STATE_POSTPONED]: "POSTPONED",
            [TODO_STATE_CANCELLED]: "CANCELLED",
            [TODO_STATE_DONE]: "DONE"
        };

        const TODO_STATES = {
            "TODO": TODO_STATE_TODO,
            "WAITING": TODO_STATE_WAITING,
            "POSTPONED": TODO_STATE_POSTPONED,
            "CANCELLED": TODO_STATE_CANCELLED,
            "DONE": TODO_STATE_DONE
        };

        function _styleTODO(node) {
            if (node.todo_state)
                return " todo-state-" + (node._overdue
                    ? "overdue"
                    : TODO_NAMES[node.todo_state].toLowerCase());

            return "";
        }

        function toJsTreeNode(n) {
            n.text = n.name;

            n.parent = n.parent_id;
            if (!n.parent)
                n.parent = "#";

            if (n.type == NODE_TYPE_SHELF) {
                n.icon = "var(--themed-cloud-icon)";
                n.li_attr = {"class": "cloud-shelf"};
            }
            else if (n.type == NODE_TYPE_GROUP) {
                n.icon = "var(--themed-group-icon)";
                n.li_attr = {
                    "class": "scrapyard-group",
                };
            }
            else if (n.type == NODE_TYPE_SEPARATOR) {
                n.text = "──".repeat(60);
                n.icon = false;
                n.a_attr = {
                    "class": "separator-node"
                };
            }
            else if (n.type != NODE_TYPE_SHELF) {
                let uri = "";
                if (n.uri)
                    uri = false //n.uri.length > 60
                        ? "\x0A" + n.uri.substring(0, 60) + "..."
                        : ("\x0A" + n.uri);

                n.li_attr = {
                    "class": "show_tooltip",
                    "title": `${n.text}${uri}`,
                    "data-id": n.id,
                    "data-clickable": "true"
                };

                if (n.type == NODE_TYPE_ARCHIVE)
                    n.li_attr.class += " archive-node";

                n.a_attr = {
                    "class": n.has_notes? "has-notes": "",
                    "href": n.uri
                };

                if (n.todo_state) {
                    n.a_attr.class += _styleTODO(n);

                    if (n._extended_todo) {
                        n.li_attr.class += " extended-todo";
                        n.text = _formatTODO(n);
                    }
                }

                if (n.type == NODE_TYPE_NOTES) {
                    n.icon = "var(--themed-notes-icon)";
                    n.li_attr.class += " scrapyard-notes";
                }

                if (!n.icon) {
                    n.icon = "var(--themed-globe-icon)";
                    n.a_attr.class += " generic-icon";
                }
            }

            n.data = {};
            n.data.uuid = n.uuid;

            return n;
        }

        $("#treeview").jstree({
            plugins: ["wholerow"],
            core: {
                worker: false,
                animation: 0,
                multiple: false,
                themes: {
                    name: "default",
                    dots: false,
                    icons: true,
                },
            }
        })
        .on("select_node.jstree", function (e, data) {
            let node = data.node.original;
            if (node.type === NODE_TYPE_BOOKMARK || node.type === NODE_TYPE_ARCHIVE)
                document.location.href = node.uri;
            else if (node.type === NODE_TYPE_GROUP || node.type === NODE_TYPE_SHELF)
                data.instance.toggle_node(data.selected);
         }) ;

        window.tree = $("#treeview").jstree(true);

        tree.__icon_check_hook = (a_element, node) => {
            if (node.__icon_validated || !node.icon || (node.icon && node.icon.startsWith("var("))
                || (node.icon && node.icon.startsWith("/")))
                return;

            setTimeout(async () => {
                let getIconElement = async () => {
                    const a_element2 = document.getElementById(a_element.id);
                    if (a_element2) {
                        return a_element2.childNodes[0];
                    }
                    else {
                        return new Promise((resolve, reject) => {
                            setTimeout(() => {
                                const a_element2 = document.getElementById(a_element.id);
                                if (a_element2) {
                                    resolve(a_element2.childNodes[0]);
                                }
                                else {
                                    console.error("can't find icon element");
                                    resolve(null);
                                }
                            }, 100);
                        })
                    }
                }

                let image = new Image();

                image.onerror = async e => {
                    const fallback_icon = "var(--themed-globe-icon)";
                    node.icon = fallback_icon;
                    (await getIconElement()).style.backgroundImage = fallback_icon;
                };
                image.src = node.icon;
            }, 0);

            node.__icon_validated = true;
        };

        let root = {id: CLOUD_SHELF_ID,
                    pos: -2,
                    name: CLOUD_SHELF_NAME,
                    uuid: CLOUD_SHELF_NAME,
                    type: NODE_TYPE_SHELF,
                    external: CLOUD_EXTERNAL_NAME
                    };

        window.nodes = [root];

        /*
        nodes.forEach(toJsTreeNode);
        tree.settings.core.data = nodes;
        tree.refresh(true);
        tree.open_node("-5");
        */
    </script>
</html>
</html>
